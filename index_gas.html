<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roulette Questioner Selector</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* =========================================
   1. Root & Base Styles
   ========================================= */
        :root {
            --bg-dark: #111111;
            --bg-card: #222222;
            --primary: #f59e0b;
            --primary-glow: rgba(245, 158, 11, 0.5);
            --secondary: #d97706;
            --secondary-glow: rgba(217, 119, 6, 0.5);
            --text-main: #f8fafc;
            --text-muted: #9ca3af;
            --border: #404040;
            --font-heading: 'Outfit', sans-serif;
            --font-body: 'Zen Kaku Gothic New', sans-serif;
            --glass: rgba(34, 34, 34, 0.8);
            --transition-fast: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-body);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(245, 158, 11, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.05) 0%, transparent 20%);
            overflow-x: hidden;
        }

        /* =========================================
   2. Layout
   ========================================= */
        .app-container {
            width: 100%;
            max-width: 1200px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }

        .split-layout {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            width: 100%;
            max-width: 1200px;
            align-items: center;
            animation: fadeIn 0.8s ease-out;
        }

        /* =========================================
   3. Header & Navigation
   ========================================= */
        .app-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .app-header h1 {
            font-family: var(--font-heading);
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.05em;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 0 10px var(--primary-glow));
        }

        .app-header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        #help-btn {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--border);
            color: var(--text-main);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        #help-btn:hover {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        /* =========================================
   4. Upload Section
   ========================================= */
        .upload-section {
            width: 100%;
            max-width: 600px;
            animation: fadeIn 0.8s ease-out;
        }

        .file-drop-area {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            border: 2px dashed var(--border);
            border-radius: 1rem;
            background: var(--glass);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-area:hover,
        .file-drop-area.dragover {
            border-color: var(--primary);
            background: rgba(245, 158, 11, 0.05);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .file-msg {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .file-sub {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .format-hint {
            text-align: center;
            margin-top: 0.5rem;
            color: var(--text-muted);
        }

        /* =========================================
   5. Presenter Tabs
   ========================================= */
        .presenter-section {
            width: 100%;
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }

        .presenter-tabs {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .presenter-tab {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: var(--font-body);
            font-weight: 700;
        }

        .presenter-tab:hover {
            background: var(--border);
        }

        .presenter-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            box-shadow: 0 4px 15px var(--primary-glow);
            transform: translateY(-2px);
        }

        /* =========================================
   6. Settings & Candidates
   ========================================= */
        .settings-candidate-section {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            animation: fadeIn 0.5s ease-out;
        }

        .settings-panel {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--glass);
            border-radius: 2rem;
            border: 1px solid var(--border);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-card);
            transition: .4s;
            border-radius: 24px;
            border: 1px solid var(--border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-muted);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
            background-color: white;
        }

        .winner-count-selector {
            display: flex;
            gap: 0.5rem;
        }

        .count-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .count-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .candidate-list-container {
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .candidate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .search-container {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-main);
            outline: none;
            transition: var(--transition-fast);
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-glow);
        }

        .candidate-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            transition: max-height 0.3s ease;
        }

        .candidate-list.collapsed {
            max-height: 0;
            padding: 0;
        }

        .candidate-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
        }

        .candidate-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .candidate-item input[type="checkbox"] {
            margin-right: 1rem;
            accent-color: var(--primary);
        }

        .candidate-item.winner {
            opacity: 0.5;
            text-decoration: line-through;
            color: var(--text-muted);
        }

        /* =========================================
   7. Roulette Wheel & Pointers
   ========================================= */
        .roulette-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            animation: zoomIn 0.8s ease-out;
        }

        .roulette-container {
            position: relative;
            width: 500px;
            height: 500px;
            max-width: 90vw;
            max-height: 90vw;
        }

        .roulette-wheel-outer {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            background: var(--bg-card);
        }

        #roulette-canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .pointers-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .pointer {
            position: absolute;
            font-size: 3rem;
            color: var(--text-main);
            filter: drop-shadow(0 0 5px var(--secondary));
            transition: var(--transition-slow);
        }

        #pointer-1 {
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
        }

        #pointer-2 {
            top: 75%;
            left: 93%;
            transform: translate(-50%, -50%) rotate(120deg);
        }

        #pointer-3 {
            top: 75%;
            left: 7%;
            transform: translate(-50%, -50%) rotate(240deg);
        }

        .mode-2 #pointer-1 {
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .mode-2 #pointer-2 {
            top: auto;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%) rotate(180deg);
        }

        /* =========================================
   8. Controls
   ========================================= */
        .controls {
            display: flex;
            gap: 1rem;
        }

        .btn {
            font-family: var(--font-heading);
            font-size: 1.2rem;
            font-weight: 700;
            padding: 1rem 3rem;
            border: none;
            border-radius: 3rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 10px 20px -5px var(--primary-glow);
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-muted);
        }

        .btn-secondary:hover {
            border-color: var(--text-main);
            color: var(--text-main);
        }

        /* =========================================
   9. Modals (Result & Help)
   ========================================= */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .result-name {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-question {
            font-size: 1.2rem;
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .result-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            animation: slideUp 0.5s ease-out;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item .result-name {
            font-size: 1.8rem;
        }

        .result-item .result-question {
            font-size: 1rem;
            padding: 1rem;
            border-radius: 0.8rem;
            text-align: left;
        }

        .modal-content.multi-winner {
            max-width: 600px;
            padding: 1.5rem;
        }

        .help-step {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        .help-step:last-child {
            border-bottom: none;
        }

        .help-step h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-step p {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .help-badge {
            background: var(--primary);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* =========================================
   10. System utilities
   ========================================= */
        .hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes popUp {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* =========================================
   11. Media Queries
   ========================================= */
        @media (min-width: 768px) {
            .split-layout {
                flex-direction: row;
                align-items: flex-start;
                justify-content: center;
                gap: 3rem;
            }

            .settings-candidate-section {
                flex: 1;
                max-width: 400px;
                position: sticky;
                top: 2rem;
            }

            .roulette-section {
                flex: 2;
                max-width: 600px;
            }

            .candidate-list {
                max-height: 500px;
            }
        }

        @media (max-width: 600px) {
            .app-header h1 {
                font-size: 2.5rem;
            }

            .btn {
                padding: 0.75rem 2rem;
                font-size: 1rem;
            }

            .roulette-container {
                width: 300px;
                height: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Roulette Selector</h1>
            <p>è³ªå•è€…ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸å‡ºã—ã¾ã™</p>
        </header>

        <main>
            <!-- File Upload Section -->
            <section class="upload-section" id="upload-section">
                <div class="file-drop-area" id="drop-area">
                    <span class="file-icon">ğŸ“‚</span>
                    <span class="file-msg">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</span>
                    <span class="file-sub">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span>
                    <input class="file-input" type="file" id="csv-input" accept=".csv">
                </div>
                <div class="format-hint">
                    <small>ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: åå‰, è³ªå•å†…å®¹, å®›å…ˆç™ºè¡¨è€…å, é™¤å¤–ã‚³ãƒ¼ãƒ‰:x (ä»»æ„)</small>
                    <p style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.8rem; opacity: 0.8;">
                        â€» ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ã®ã¿å‡¦ç†ã•ã‚Œã€å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã¸ã®é€ä¿¡ãƒ»ä¿å­˜ã¯ä¸€åˆ‡è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚
                    </p>
                </div>
            </section>

            <!-- Presenter Selection -->
            <section class="presenter-section hidden" id="presenter-section">
                <h2>Target Presenter</h2>
                <div class="presenter-tabs" id="presenter-tabs">
                    <!-- Dynamic buttons will be inserted here -->
                </div>
            </section>

            <!-- Split Layout Container -->
            <div id="split-layout-container" class="split-layout hidden">
                <!-- Left Panel: Settings & Candidates -->
                <section class="settings-candidate-section" id="settings-candidate-section">
                    <div class="settings-panel">
                        <label class="toggle-switch">
                            <input type="checkbox" id="global-exclude-toggle" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="setting-label">å½“é¸è€…ã‚’å…¨ç™»éŒ²è€…ã‹ã‚‰é™¤å¤–</span>
                    </div>
                    <div class="settings-panel">
                        <label class="toggle-switch">
                            <input type="checkbox" id="include-all-toggle">
                            <span class="slider"></span>
                        </label>
                        <span class="setting-label">å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŠ½é¸</span>
                    </div>

                    <div class="settings-panel">
                        <span class="setting-label">å½“é¸äººæ•°:</span>
                        <div class="winner-count-selector" id="winner-count-selector">
                            <button class="count-btn active" data-count="1">1</button>
                            <button class="count-btn" data-count="2">2</button>
                            <button class="count-btn" data-count="3">3</button>
                        </div>
                    </div>

                    <div class="candidate-list-container">
                        <div class="candidate-header">
                            <h3>Candidates <span id="candidate-count">(0)</span></h3>
                            <button id="toggle-list-btn" class="btn-text">â–¼</button>
                        </div>
                        <div class="search-container">
                            <input type="text" id="candidate-search" placeholder="åå‰ã‚’æ¤œç´¢..." class="search-input">
                        </div>
                        <div class="candidate-list" id="candidate-list">
                            <!-- Dynamic checkboxes -->
                        </div>
                    </div>
                </section>

                <!-- Right Panel: Roulette -->
                <section class="roulette-section" id="roulette-section">
                    <div class="roulette-container">
                        <div class="roulette-wheel-outer">
                            <div class="pointers-container" id="pointers-container">
                                <div class="pointer" id="pointer-1">â–¼</div>
                                <div class="pointer hidden" id="pointer-2">â–¼</div>
                                <div class="pointer hidden" id="pointer-3">â–¼</div>
                            </div>
                            <canvas id="roulette-canvas" width="500" height="500"></canvas>
                        </div>
                    </div>

                    <div class="controls">
                        <button id="spin-btn" class="btn btn-primary">START</button>
                        <button id="reset-btn" class="btn btn-secondary">RESET</button>
                    </div>
                </section>
            </div>
        </main>

        <!-- Result Modal -->
        <div id="result-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Selected Questioner</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="result-name" id="result-name"></div>
                    <div class="result-question" id="result-question"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary close-modal-btn">OK</button>
                </div>
            </div>
            <div class="confetti-container" id="confetti-container"></div>
        </div>
    </div>

    <!-- ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="help-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
                <button class="close-modal" id="close-help">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-step">
                    <h4><span class="help-badge">1</span> CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™</h4>
                    <p>åå‰, è³ªå•å†…å®¹, å®›å…ˆç™ºè¡¨è€…å, é™¤å¤–ãƒ•ãƒ©ã‚°(x) ã®å½¢å¼ã§CSVã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                </div>
                <div class="help-step">
                    <h4><span class="help-badge">2</span> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿</h4>
                    <p>ä½œæˆã—ãŸCSVã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
                </div>
                <div class="help-step">
                    <h4><span class="help-badge">3</span> ç™ºè¡¨è€…ã‚’é¸æŠ</h4>
                    <p>ç”»é¢ä¸‹éƒ¨ã®ã‚¿ãƒ–ã‹ã‚‰ã€è³ªå•å¯¾è±¡ã®ç™»å£‡è€…ã‚’é¸æŠã—ã¾ã™ã€‚å€‹åˆ¥ã«é™¤å¤–è¨­å®šã‚‚å¯èƒ½ã§ã™ã€‚</p>
                </div>
                <div class="help-step">
                    <h4><span class="help-badge">4</span> å½“é¸äººæ•°ã‚’è¨­å®š</h4>
                    <p>ã€Œå½“é¸äººæ•°ã€ãƒœã‚¿ãƒ³ï¼ˆ1ã€œ3äººï¼‰ã§åŒæ™‚ã«é¸å‡ºã™ã‚‹äººæ•°ã‚’è¨­å®šã§ãã¾ã™ã€‚äººæ•°ã«åˆã‚ã›ã¦çŸ¢å°ãŒå¢—ãˆã¾ã™ã€‚</p>
                </div>
                <div class="help-step">
                    <h4><span class="help-badge">5</span> æŠ½é¸ã‚¹ã‚¿ãƒ¼ãƒˆ</h4>
                    <p>ã€ŒSTARTã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’å›ã—ã¾ã™ã€‚é¸å‡ºã•ã‚ŒãŸè³ªå•è€…ãŒä¸€æ‹¬è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="help-ok-btn">äº†è§£</button>
            </div>
        </div>
    </div>

    <button id="help-btn" title="ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰">?</button>
    <script>
        // --- è¨­å®šãƒ»å®šæ•° ---
        const CONFIG = {
            WHEEL_COLORS: [
                '#f59e0b', '#f43f5e', '#d946ef', '#8b5cf6', '#6366f1', '#0ea5e9', '#10b981', '#f97316'
            ],
            SPIN_DURATION: 5000,
            MIN_SPINS: 5,
            POINTER_ANGLES: {
                1: [270],
                2: [270, 90],
                3: [270, 30, 150]
            },
            FONT_FAMILY_BODY: "'Zen Kaku Gothic New', sans-serif"
        };

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ ---
        const appState = {
            allParticipants: [],
            currentParticipants: [],
            presenters: new Set(),
            currentPresenter: null,
            currentRotation: 0,
            isSpinning: false,
            globalWinners: new Set(),
            excludedIDs: new Set(),
            winnerCount: 1
        };

        // --- DOMè¦ç´  ---
        const UI = {
            csvInput: document.getElementById('csv-input'),
            dropArea: document.getElementById('drop-area'),
            presenterSection: document.getElementById('presenter-section'),
            presenterTabs: document.getElementById('presenter-tabs'),
            settingsSection: document.getElementById('settings-candidate-section'),
            globalExcludeToggle: document.getElementById('global-exclude-toggle'),
            includeAllToggle: document.getElementById('include-all-toggle'),
            candidateList: document.getElementById('candidate-list'),
            candidateCount: document.getElementById('candidate-count'),
            candidateSearch: document.getElementById('candidate-search'),
            toggleListBtn: document.getElementById('toggle-list-btn'),
            rouletteSection: document.getElementById('roulette-section'),
            canvas: document.getElementById('roulette-canvas'),
            spinBtn: document.getElementById('spin-btn'),
            resetBtn: document.getElementById('reset-btn'),
            resultModal: document.getElementById('result-modal'),
            resultName: document.getElementById('result-name'),
            resultQuestion: document.getElementById('result-question'),
            closeModalBtns: document.querySelectorAll('.close-modal, .close-modal-btn'),
            winnerCountSelector: document.getElementById('winner-count-selector'),
            pointersContainer: document.getElementById('pointers-container'),
            pointers: [
                document.getElementById('pointer-1'),
                document.getElementById('pointer-2'),
                document.getElementById('pointer-3')
            ],
            help: {
                btn: document.getElementById('help-btn'),
                modal: document.getElementById('help-modal'),
                closeBtn: document.getElementById('close-help'),
                okBtn: document.getElementById('help-ok-btn')
            }
        };

        const ctx = UI.canvas.getContext('2d');

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        const initEventListeners = () => {
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(name => {
                UI.dropArea.addEventListener(name, e => { e.preventDefault(); e.stopPropagation(); });
            });
            UI.dropArea.addEventListener('dragenter', () => UI.dropArea.classList.add('dragover'));
            UI.dropArea.addEventListener('dragover', () => UI.dropArea.classList.add('dragover'));
            UI.dropArea.addEventListener('dragleave', () => UI.dropArea.classList.remove('dragover'));
            UI.dropArea.addEventListener('drop', e => {
                UI.dropArea.classList.remove('dragover');
                handleFiles({ target: { files: e.dataTransfer.files } });
            });

            UI.csvInput.addEventListener('change', handleFiles);
            UI.spinBtn.addEventListener('click', spinRoulette);
            UI.resetBtn.addEventListener('click', resetApp);
            UI.closeModalBtns.forEach(btn => btn.addEventListener('click', closeResult));

            // ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰
            if (UI.help.btn) {
                const toggleHelp = (show) => UI.help.modal.classList.toggle('hidden', !show);
                UI.help.btn.addEventListener('click', () => toggleHelp(true));
                UI.help.closeBtn?.addEventListener('click', () => toggleHelp(false));
                UI.help.okBtn?.addEventListener('click', () => toggleHelp(false));
                UI.help.modal.addEventListener('click', (e) => {
                    if (e.target === UI.help.modal) toggleHelp(false);
                });
            }

            // å„ç¨®ãƒˆã‚°ãƒ«ãƒ»ã‚¹ã‚¤ãƒƒãƒ
            UI.globalExcludeToggle?.addEventListener('change', () => selectPresenter(appState.currentPresenter));
            UI.includeAllToggle?.addEventListener('change', () => selectPresenter(appState.currentPresenter));

            // å½“é¸äººæ•°
            if (UI.winnerCountSelector) {
                const btns = UI.winnerCountSelector.querySelectorAll('.count-btn');
                btns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        btns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        appState.winnerCount = parseInt(btn.dataset.count);
                        updatePointerVisibility();
                    });
                });
            }

            // å€™è£œè€…ãƒªã‚¹ãƒˆã®é–‹é–‰
            const toggleList = () => {
                UI.candidateList.classList.toggle('collapsed');
                const isCollapsed = UI.candidateList.classList.contains('collapsed');
                UI.toggleListBtn.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
            };
            UI.toggleListBtn?.addEventListener('click', toggleList);
            document.querySelector('.candidate-header')?.addEventListener('click', toggleList);

            // æ¤œç´¢
            UI.candidateSearch?.addEventListener('input', e => {
                const term = e.target.value.toLowerCase();
                UI.candidateList.querySelectorAll('.candidate-item').forEach(item => {
                    item.style.display = item.textContent.toLowerCase().includes(term) ? 'flex' : 'none';
                });
            });
        };

        const updatePointerVisibility = () => {
            UI.pointers[1]?.classList.toggle('hidden', appState.winnerCount < 2);
            UI.pointers[2]?.classList.toggle('hidden', appState.winnerCount < 3);
            UI.pointersContainer?.classList.toggle('mode-2', appState.winnerCount === 2);
        };

        // --- ä¸»è¦é–¢æ•° ---
        function handleFiles(e) {
            const file = e.target.files[0];
            if (file && (file.type === 'text/csv' || file.name.endsWith('.csv'))) {
                const reader = new FileReader();
                reader.onload = event => parseCSV(event.target.result);
                reader.readAsText(file);
            } else {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function parseCSV(text) {
            appState.allParticipants = [];
            appState.presenters = new Set();
            appState.globalWinners = new Set();
            appState.excludedIDs = new Set();

            const rows = [];
            let currentRow = [], currentField = '', insideQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i], nextChar = text[i + 1];
                if (char === '"') {
                    if (insideQuotes && nextChar === '"') { currentField += '"'; i++; }
                    else { insideQuotes = !insideQuotes; }
                } else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentField); currentField = '';
                } else if ((char === '\r' || char === '\n') && !insideQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    currentRow.push(currentField);
                    if (currentRow.length > 1 || (currentRow[0] && currentRow[0] !== '')) rows.push(currentRow);
                    currentRow = []; currentField = '';
                } else {
                    currentField += char;
                }
            }
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField);
                if (currentRow.length > 1 || (currentRow[0] && currentRow[0] !== '')) rows.push(currentRow);
            }

            rows.forEach((parts, index) => {
                const name = parts[0]?.trim() || '';
                const question = parts[1]?.trim() || '';
                const target = parts[2]?.trim() || 'All';
                const isExcluded = ['x', 'X', '*'].includes(parts[3]?.trim());
                const id = `p-${index}-${Date.now()}`;

                if (name && question) {
                    appState.allParticipants.push({ id, name, question, target });
                    appState.presenters.add(target);
                    if (isExcluded) appState.excludedIDs.add(id);
                }
            });

            if (appState.allParticipants.length === 0) {
                alert('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                return;
            }

            initPresenterTabs();

            UI.uploadSection = document.getElementById('upload-section'); // Helper check
            UI.uploadSection?.classList.add('hidden');
            UI.presenterSection.classList.remove('hidden');
            document.getElementById('split-layout-container')?.classList.remove('hidden');

            if (appState.presenters.size > 0) {
                selectPresenter(Array.from(appState.presenters)[0]);
            }
        }

        function initPresenterTabs() {
            UI.presenterTabs.innerHTML = '';
            appState.presenters.forEach(presenter => {
                const btn = document.createElement('button');
                btn.className = 'presenter-tab';
                btn.textContent = presenter;
                btn.addEventListener('click', () => selectPresenter(presenter));
                UI.presenterTabs.appendChild(btn);
            });
        }

        function selectPresenter(presenter) {
            if (!presenter) return;
            appState.currentPresenter = presenter;

            UI.presenterTabs.querySelectorAll('.presenter-tab').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === presenter);
            });

            const isGlobalExclude = UI.globalExcludeToggle?.checked ?? true;
            const isIncludeAll = UI.includeAllToggle?.checked ?? false;

            let potentialCandidates = (isIncludeAll || presenter === 'All')
                ? [...appState.allParticipants]
                : appState.allParticipants.filter(p => p.target === presenter);

            appState.currentParticipants = potentialCandidates.filter(p => {
                if (appState.excludedIDs.has(p.id)) return false;
                if (isGlobalExclude && appState.globalWinners.has(p.name)) return false;
                return true;
            });

            if (UI.candidateCount) UI.candidateCount.textContent = `(${appState.currentParticipants.length})`;
            renderCandidateList(potentialCandidates);
            drawWheel();
        }

        function renderCandidateList(candidates) {
            if (!UI.candidateList) return;
            UI.candidateList.innerHTML = '';
            const searchTerm = UI.candidateSearch?.value.toLowerCase() || '';

            candidates.forEach(p => {
                const isGlobalWinner = appState.globalWinners.has(p.name);
                const isExcluded = appState.excludedIDs.has(p.id);

                const item = document.createElement('div');
                item.className = `candidate-item ${isGlobalWinner ? 'winner' : ''}`;
                if (searchTerm && !p.name.toLowerCase().includes(searchTerm)) item.style.display = 'none';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = !isExcluded;
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) appState.excludedIDs.delete(p.id);
                    else appState.excludedIDs.add(p.id);
                    selectPresenter(appState.currentPresenter);
                });

                const label = document.createElement('span');
                label.textContent = p.name + (isGlobalWinner ? ' (å½“é¸æ¸ˆ)' : '');

                item.appendChild(checkbox);
                item.appendChild(label);
                UI.candidateList.appendChild(item);
            });
        }

        function drawWheel() {
            if (appState.currentParticipants.length === 0) {
                ctx.clearRect(0, 0, UI.canvas.width, UI.canvas.height);
                return;
            }

            const arc = Math.PI * 2 / appState.currentParticipants.length;
            const radius = UI.canvas.width / 2;

            ctx.clearRect(0, 0, UI.canvas.width, UI.canvas.height);
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.translate(radius, radius);

            appState.currentParticipants.forEach((participant, i) => {
                const angle = i * arc;
                ctx.beginPath();
                ctx.fillStyle = CONFIG.WHEEL_COLORS[i % CONFIG.WHEEL_COLORS.length];
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, angle, angle + arc);
                ctx.lineTo(0, 0);
                ctx.fill();

                ctx.save();
                ctx.fillStyle = "white";
                const textRadius = radius - 20;
                const fontSize = Math.max(10, Math.min(20, (textRadius * arc) * 0.55));
                ctx.font = `bold ${fontSize}px ${CONFIG.FONT_FAMILY_BODY}`;
                ctx.textAlign = "right";
                ctx.textBaseline = "middle";
                ctx.rotate(angle + arc / 2);
                ctx.fillText(participant.name, radius - 20, 0);
                ctx.restore();
            });
        }

        function spinRoulette() {
            if (appState.isSpinning || appState.currentParticipants.length === 0) return;
            appState.isSpinning = true;
            UI.spinBtn.disabled = true;

            const randomExtra = Math.random() * 360;
            const targetRotation = appState.currentRotation + (CONFIG.MIN_SPINS * 360) + randomExtra;

            UI.canvas.style.transition = `transform ${CONFIG.SPIN_DURATION / 1000}s cubic-bezier(0.15, 0, 0.15, 1)`;
            UI.canvas.style.transform = `rotate(${targetRotation}deg)`;
            appState.currentRotation = targetRotation;

            setTimeout(() => {
                const winners = [];
                const arcDegrees = 360 / appState.currentParticipants.length;
                const normalizedRotation = targetRotation % 360;
                const pointerAngles = CONFIG.POINTER_ANGLES[appState.winnerCount] || CONFIG.POINTER_ANGLES[1];

                pointerAngles.forEach(pAngle => {
                    let wheelAngle = (pAngle - normalizedRotation) % 360;
                    if (wheelAngle < 0) wheelAngle += 360;

                    const winnerIndex = Math.floor(wheelAngle / arcDegrees);
                    const winner = appState.currentParticipants[winnerIndex];

                    if (winner && !winners.some(w => w.id === winner.id)) {
                        winners.push(winner);
                    } else if (winner) {
                        const unused = appState.currentParticipants.filter(p => !winners.some(w => w.id === p.id));
                        if (unused.length > 0) winners.push(unused[Math.floor(Math.random() * unused.length)]);
                    }
                });
                finishSpin(winners);
            }, CONFIG.SPIN_DURATION);
        }

        function finishSpin(winners) {
            appState.isSpinning = false;
            UI.spinBtn.disabled = false;
            if (winners && winners.length > 0) {
                winners.forEach(w => appState.globalWinners.add(w.name));
                selectPresenter(appState.currentPresenter);
                showResult(winners);
            }
        }

        function showResult(winners) {
            if (!winners || winners.length === 0) return;
            const isIncludeAll = UI.includeAllToggle?.checked ?? false;
            const modalContent = UI.resultModal.querySelector('.modal-content');
            const modalBody = UI.resultModal.querySelector('.modal-body');

            // æ—¢å­˜ãƒªã‚¶ãƒ«ãƒˆã®ã‚¯ãƒªã‚¢
            UI.resultModal.querySelectorAll('.result-item').forEach(item => item.remove());

            if (winners.length === 1) {
                modalContent.classList.remove('multi-winner');
                const winner = winners[0];
                UI.resultName.textContent = winner.name;
                UI.resultQuestion.textContent = isIncludeAll ? "ç™ºè¡¨ã‚’èã„ã¦ã®è³ªå•ã‚’ãŠé¡˜ã„ã—ã¾ã™" : winner.question;
                UI.resultName.style.display = 'block';
                UI.resultQuestion.style.display = 'block';
            } else {
                modalContent.classList.add('multi-winner');
                UI.resultName.style.display = 'none';
                UI.resultQuestion.style.display = 'none';
                winners.forEach(winner => {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                <div class="result-name">${winner.name}</div>
                <div class="result-question">${isIncludeAll ? "ç™ºè¡¨ã‚’èã„ã¦ã®è³ªå•ã‚’ãŠé¡˜ã„ã—ã¾ã™" : winner.question}</div>
            `;
                    modalBody.appendChild(item);
                });
            }
            UI.resultModal.classList.remove('hidden');
        }

        function closeResult() { UI.resultModal.classList.add('hidden'); }

        function resetApp() {
            UI.csvInput.value = '';
            document.getElementById('upload-section')?.classList.remove('hidden');
            UI.presenterSection.classList.add('hidden');
            document.getElementById('split-layout-container')?.classList.add('hidden');
            UI.resultModal.classList.add('hidden');
            UI.canvas.style.transition = 'none';
            UI.canvas.style.transform = 'rotate(0deg)';

            appState.currentRotation = 0;
            appState.allParticipants = [];
            appState.currentParticipants = [];
            appState.globalWinners = new Set();
            appState.excludedIDs = new Set();
        }

        // --- åˆæœŸåŒ– ---
        const init = () => {
            initEventListeners();
        };

        init();
    </script>
</body>

</html>